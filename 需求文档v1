# 功能需求规格说明书 (FRD) - Claude Code CLI 复现项目

**版本**: 1.3
**日期**: 2026-02-09
**状态**: 拟定中

---

## 1. 引言 (Introduction)

### 1.1 项目背景
本项目旨在构建一个高性能、模块化的 AI 辅助编程 CLI 工具。系统通过模拟人类工程师的“探索-决策-执行”循环，利用 LLM（Anthropic API）直接在终端中协助开发者完成代码理解、编辑、测试和重构任务。

### 1.2 设计原则
*   **Agentic Workflow**: 不依赖静态的全库地图，而是赋予 Agent 使用 `ls`, `grep`, `read` 等工具自主探索代码库的能力。
*   **Human-in-the-Loop**: 关键操作（如文件修改、命令执行）必须经过用户授权或符合预设的安全策略。
*   **轻量化架构**: 采用宿主机进程 + 权限拦截模式，而非重型容器沙箱，确保与用户开发环境的无缝融合。

---

## 2. 系统架构概览 (System Architecture)

系统由五大核心层级组成，数据流向如下：

```text
用户输入 (Terminal) -> 会话管理 (Session) -> 命令编排 (Orchestration) 
                         -> 主代理 (Main Agent) -> 工具执行 (Tools)
```

---

## 3. 功能模块详情 (Functional Requirements)

### 模块 1: 终端交互与会话管理 (Terminal & Session Layer)

负责处理用户的原始输入输出及会话生命周期。

#### 功能点 1.1: REPL 交互循环
*   **功能描述**: 提供类似 Shell 的交互式界面，支持流式输出渲染。
*   **输入参数**: `stdin` 字符流。
*   **处理逻辑**:
    1.  初始化 `readline` 接口，显示自定义提示符（如 `>>`）。
    2.  监听用户输入，支持多行模式（Paste Mode）。
    3.  **输入解析**:
        *   若输入以 `/` 开头（如 `/help`），路由至 **命令编排层**。
        *   若为普通文本，封装为 `UserMessage`，路由至 **主代理**。
    4.  **流式渲染**: 接收 LLM 或工具的 `stdout`，实时渲染 Markdown/高亮代码至终端。
*   **输出**: 渲染后的终端界面。
*   **依赖项**: `prompt_toolkit` (Python) 或类似库。

#### 功能点 1.2: 会话上下文管理 (Context Management)
*   **功能描述**: 维护当前会话的消息历史，并执行压缩策略。
*   **处理逻辑**:
    1.  维护一个内存数组 `messages[]`，存储 User/Assistant/Tool 类型的消息。
    2.  **Token 监控**: 每次追加消息前，估算当前 Total Tokens。
    3.  **压缩策略**:
        *   当 Token 使用量 > 90% (Context Window Limit) 时触发。
        *   **动作**: 保留最近 N 轮交互（滑动窗口），将更早期的交互发送给 LLM 生成一段 `Summary`（摘要），替换掉旧消息。
*   **异常处理**: 若单条消息超过 Context 限制，直接报错拒绝处理。

#### 功能点 1.3: 上下文显式提取 (Smart Context Extractor)
*   **功能描述**: 主动解析用户输入中的 `@file` 引用，智能查找文件并注入上下文，减少 Agent 的初始探索成本。
*   **输入格式**: `@file:keyword` (例如 `@file:agent`, `@file:src/core/session.py`)。
*   **处理逻辑**:
    1.  **解析**: 提取 `@file:` 后的关键词。
    2.  **智能匹配**:
        *   调用 `Glob` 或模糊搜索在项目中查找匹配的文件。
        *   **Case 1 (唯一匹配)**: 自动读取该文件内容。
        *   **Case 2 (多项匹配)**: 所以匹配文件都读取。
        *   **Case 3 (无匹配)**: 提示警告。
    3.  **注入**: 将读取的内容封装为 `<Context><File path="...">...</File></Context>` 格式，附在 User Message 中。
*   **适用范围**: 主代理交互及子代理的任务描述。

---

### 模块 2: 命令编排层 (Command Orchestration Layer)

负责处理 `/command` 形式的快捷指令。

#### 功能点 2.1: Slash Command 解析与分发
*   **功能描述**: 解析用户指令并执行对应逻辑。
*   **输入参数**: 命令字符串 (e.g., `/add src/utils.py`)。
*   **处理逻辑**:
    1.  解析命令名（`add`）和参数列表（`['src/utils.py']`）。
    2.  查找注册的命令处理器。
    3.  **内置命令示例**:
        *   `/clear`: 清空 `messages[]` 数组。
        *   `/config`: 读取/修改内存中的配置对象。
        *   `/help`: 显示可用命令列表。
    4.  若命令不存在，在终端输出错误提示。

---

### 模块 3: 智能体执行层 (Agent Execution Layer)

系统的核心大脑，负责决策与递归任务执行。

#### 功能点 3.1: Main Agent 决策循环 (Think-Act Loop)
*   **功能描述**: 驱动 LLM 进行思考和行动的主循环。
*   **输入参数**: `Session Context`。
*   **处理逻辑**:
    1.  **构造 Prompt**: 拼接 System Prompt + Context + Available Tools Schema。
    2.  **API 调用**: 发送请求至 LLM (Anthropic Claude 3.5 Sonnet)。
    3.  **响应处理**:
        *   若 LLM 返回文本内容：直接显示给用户。
        *   若 LLM 返回 `tool_use` 请求：暂停等待，将请求转发给 **工具执行层**。
    4.  **递归/循环**: 接收工具执行结果 (Tool Result)，将其追加到 Context，再次跳转至步骤 1，直到 LLM 停止调用工具。

#### 功能点 3.2: 子代理生成 (Task Tool / Sub-agent)
*   **功能描述**: 允许 Main Agent 创建子代理来处理隔离的复杂任务，支持可选的 Plan Mode (任务规划模式)。
*   **处理逻辑**:
    1.  Main Agent 调用 `Task` 工具，传入 `description` 和 `goals`。
        *   *优化*: 主代理可显式选择将必要的 Context 片段传递给子代理，而非全量或全空。
        *   **优化 (混合模式 Hybrid Model)**: 主代理需充当 Technical Lead 角色，显式提供线索：
            *   `resources` (List[str]): 涉及的关键文件路径或目录。
            *   `hints` (str): 技术实现建议。
    2.  **实例化**: 系统创建一个新的 `Agent` 实例（即 Sub-agent）。
        *   **初始化增强**: Sub-agent 启动时，System Prompt 会包含 Main Agent 提供的 `resources` 和 `hints`，使其快速定位上下文。
    3.  **任务管理与规划 (Plan Mode)**:
        *   若开启规划模式，主代理先生成任务清单 (Task Plan)，包含任务依赖关系。
        *   **状态追踪**: 记录每个任务 ID、状态（Pending/Running/Completed/Failed）、执行结果、错误信息。
        *   **动态调整**: 若子任务失败，主代理介入决策：
            *   重试 / 调整规划 / 询问用户是否回滚。
            *   调用 `UpdateTask` 工具中断或修改后续任务。
    4.  **栈式执行**: Main Agent 挂起（`await`），控制权移交给 Sub-agent 运行其决策循环。
        *   *技术说明*: 依赖全异步 ToolExecutor 架构，确保主事件循环不被阻塞。
    5.  **结果回传**: Sub-agent 完成任务后，返回最终结果字符串。
    6.  Main Agent 恢复，将 Sub-agent 的结果视为一次普通的工具调用输出。
*   **通信模式**: 内存函数调用栈 (Function Call Stack)，父子同步等待。

#### 功能点 3.3: 上下文监控与压缩 (Context Monitor)
*   **功能描述**: 实时监控上下文长度，避免 API 超限。
*   **处理逻辑**:
    1.  **定义有效窗口**: `Effective Window = Model Max Window - Reserved Output Tokens` (e.g., 200k - 8k = 192k)。
    2.  **实时统计**: 每次交互前计算 `Usage Ratio = Current Tokens / Effective Window`。
    3.  **阈值触发**: 当 `Usage Ratio > 90%` 时触发压缩。
    4.  **压缩策略**:
        *   记录压缩边界 (Compression Boundary)，仅压缩新增内容，避免重复计算。
        *   保留原始对话记录在磁盘/内存，仅在必要时回溯。
        *   子代理拥有独立的上下文计数器，不占用主代理窗口（但在 LLM 调用时仍受限于 API 上限）。

---

### 模块 4: 工具执行与安全层 (Tool Execution & Security)

负责实际的系统操作，强调“探索能力”与“安全性”。

#### 功能点 4.1: 权限拦截策略 (Permission Policy)
*   **功能描述**: 在执行任何工具前进行安全校验。
*   **处理逻辑**:
    1.  拦截工具调用请求 (Tool Name, Args)。
    2.  **策略判断**:
        *   **Auto-Allow**: 针对只读工具 (`Read`, `Ls`, `Grep`, `Glob`)，直接放行。
        *   **Confirm-Required**: 针对副作用工具 (`Write`, `Edit`, `Bash`)，在终端显示操作详情（如“将修改 file.py 的第 10-20 行”），等待用户输入 `y/n`。
    3.  若用户拒绝，向 LLM 返回 `ToolError: User denied execution`。

#### 功能点 4.2: 探索型工具集 (Discovery Tools)
*   **设计目标**: 赋予 Agent 类似人类的探索能力。
*   **核心工具**:
    *   **`LS`**: 列出目录结构。
    *   **`Glob`**: 根据模式寻找文件（如 `**/*.test.ts`）。
    *   **`Grep`**: 搜索文件内容（基于 `ripgrep`，支持正则）。
    *   **`Read`**: 读取文件内容（支持行号范围 `start_line` - `end_line` 以节省 Token）。

#### 功能点 4.3: 统一 Shell 执行器 (Unified Shell Executor)
*   **功能描述**: 提供一个底层的、跨平台的 Shell 执行服务，既支持系统内部调用（如 Glob 搜索），也支持通过工具暴露给 LLM。
*   **设计原则**:
    *   **统一入口**: `ShellExecutor.run(cmd)`。
    *   **跨平台**: Windows 自动使用 PowerShell，Linux/Mac 使用 Bash。
    *   **安全沙箱**: 强制 CWD、黑名单拦截、超时控制。
*   **使用场景**:
    1.  **Context Gathering**: 系统内部调用 Shell 进行文件查找、Git 状态检查。
    2.  **Tool Execution**: 封装为 `run_shell` 工具供 Agent 使用。

#### 功能点 4.4: 宿主机 Bash 执行 (Local Bash Tool)
*   **功能描述**: 基于 `ShellExecutor` 封装的 LLM 工具。
*   **处理逻辑**:
    1.  接收 LLM 的 `command` 参数。
    2.  调用 `ShellExecutor.run()`。
    3.  返回标准输出或错误信息。

---

### 模块 5: Hook 系统 (Middleware Layer)

#### 功能点 5.1: 生命周期钩子
*   **功能描述**: 允许在特定节点注入逻辑。
*   **支持节点**:
    *   `SessionStart`: 加载项目特定的 `.clauderc` 或 `GUIDELINES.md` 到 System Prompt。
    *   `PreToolUse`: 在权限检查前执行（例如：自动修正常见的参数格式错误）。
    *   `PostToolUse`: 在工具执行后执行（例如：记录审计日志）。

---

## 4. 未来规划 (Future Roadmap / Backlog)

以下功能不在本次 MVP (Minimum Viable Product) 范围内，但保留接口以便未来扩展：

1.  **Git 深度集成**: 自动 Commit、脏状态检测、Diff 视图。
2.  **成本监控面板**: 实时显示 Token 消耗与 USD 成本估算。
3.  **错误自愈循环**: 运行测试 -> 失败 -> 自动修复 -> 重试。
4.  **LSP 集成**: 使用 Language Server Protocol 进行精准的代码跳转与补全。
